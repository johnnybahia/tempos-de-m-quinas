<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento Fabril</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
      :root { --primary: #0056b3; --success: #28a745; --danger: #dc3545; --dark: #333; --light: #f4f6f9; }
      body { font-family: 'Roboto', sans-serif; background-color: var(--light); margin: 0; padding: 0; color: #333; }
      
      #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #004a99, #002a5c); display: flex; justify-content: center; align-items: center; z-index: 2000; }
      .login-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 15px 30px rgba(0,0,0,0.3); width: 90%; max-width: 320px; text-align: center; }
      .login-logo { max-width: 180px; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto; }
      .login-card h2 { margin-top: 0; color: var(--primary); font-size: 18px; text-transform: uppercase; margin-bottom: 20px; }
      .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
      .login-card button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
      
      #app-container { display: none; padding: 10px; max-width: 1400px; margin: 0 auto; }
      header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
      h1 { margin: 0; font-size: 22px; text-transform: uppercase; color: var(--dark); }
      .user-badge { font-size: 13px; color: #555; background: #e9ecef; padding: 5px 12px; border-radius: 15px; }
      
      .family-section { margin-bottom: 40px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
      .family-title { 
        font-size: 18px; color: #fff; background: var(--primary); 
        padding: 8px 15px; border-radius: 5px; margin: -15px -15px 15px -15px; 
        text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; }
      
      .card { 
        background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 15px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s; position: relative; overflow: hidden; display: flex; flex-direction: column;
      }
      .card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
      
      .card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: #ccc; }
      .card.rodando::before { background: var(--success); }
      .card.parada::before { background: var(--danger); }
      
      .card-title { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 10px; min-height: 35px; display: flex; align-items: center; line-height: 1.2; cursor: pointer; }
      .card-status { font-size: 12px; font-weight: bold; color: white; padding: 4px 10px; border-radius: 4px; display: inline-block; margin-bottom: 10px; text-transform: uppercase; align-self: flex-start; }
      .card-timer { font-size: 32px; font-family: 'Courier New', monospace; color: var(--dark); font-weight: 700; margin-bottom: 15px; }
      
      .card-daily-totals { background: #f8f9fa; border-radius: 5px; padding: 8px; font-size: 11px; color: #666; width: 100%; box-sizing: border-box; border: 1px solid #eee; }
      .daily-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
      .daily-val-prod { color: var(--success); font-weight: bold; }
      .daily-val-stop { color: var(--danger); font-weight: bold; }
      .card-turno { font-size: 11px; color: #999; margin-top: 8px; text-align: right; }
      
      .btn-stops { 
        background: none; border: 1px solid #ddd; color: #666; font-size: 11px; 
        padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-top: 10px; width: 100%; text-align: center; font-weight: bold;
      }
      .btn-stops:hover { background: #eee; }
      
      .stops-list {
        display: none; margin-top: 10px; background: #fff8f8; padding: 8px; border: 1px dashed #fcc; border-radius: 4px; font-size: 10px; color: #555;
      }
      .stops-row { margin-bottom: 3px; display: flex; justify-content: space-between; }
      .stops-label { font-weight: bold; }

      .card-footer-hint {
        margin-top: 5px; padding-top: 8px; font-size: 10px; color: #999; text-align: center; text-transform: uppercase; font-weight: bold; border-top: 1px dashed #eee; width: 100%; cursor: pointer;
      }

      .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
      .modal-content { background: white; width: 95%; max-width: 900px; max-height: 95vh; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
      .modal-header { padding: 15px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: bold; }
      .close { cursor: pointer; font-size: 24px; }
      .tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #ddd; }
      .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #666; font-weight: bold; font-size: 14px; }
      .tab.active { background: white; color: var(--primary); border-top: 3px solid var(--primary); border-bottom: 1px solid white; }
      .tab-body { padding: 20px; overflow-y: auto; flex: 1; }
      .hidden { display: none; }
      
      .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .form-group { margin-bottom: 12px; }
      label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #555; text-transform: uppercase; }
      select, input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
      button.save { width: 100%; background: var(--success); color: white; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 14px; }

      /* Filtro e Impress√£o */
      .hist-controls { 
        display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 15px; padding: 15px; background: #f1f3f5; border-radius: 6px; 
      }
      .hist-controls button {
        padding: 8px 15px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; height: 35px;
      }
      .btn-buscar { background: var(--primary); color: white; }
      .btn-tudo { background: #6c757d; color: white; }
      .btn-print { background: #17a2b8; color: white; margin-left: auto; }

      .table-wrapper { overflow-x: auto; }
      table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 5px; min-width: 800px; }
      th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; white-space: nowrap; }
      th { background: #f1f3f5; color: #444; font-weight: bold; }
      tr:hover { background: #f8f9fa; }
      td.obs { white-space: normal; min-width: 150px; }
    </style>
  </head>
  <body>

    <div id="login-overlay">
      <div class="login-card">
        <img src="https://i.ibb.co/FGGjdsM/LOGO-MARFIM.jpg" alt="Logo Marfim" class="login-logo">
        <h2>Monitoramento online de produ√ß√£o</h2>
        <input type="text" id="login-user" placeholder="Usu√°rio">
        <input type="password" id="login-pass" placeholder="Senha">
        <button onclick="tentarLogin()">ENTRAR</button>
        <div id="login-msg" style="color:red; font-size:12px; margin-top:10px;"></div>
      </div>
    </div>

    <div id="app-container">
      <header>
        <h1>Painel de Produ√ß√£o</h1>
        <div class="user-badge" id="user-display">Usu√°rio</div>
      </header>
      
      <div id="maquinas-grid" class="grid">
        <p style="text-align:center;">Carregando dados...</p>
      </div>
    </div>

    <div id="modal-detalhes" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span id="modal-titulo">M√°quina</span>
          <span class="close" onclick="fecharModal()">&times;</span>
        </div>
        <div class="tabs">
          <div class="tab active" onclick="switchTab('apontamento', event)">üìù Apontamento</div>
          <div class="tab" onclick="switchTab('historico', event)">üìÖ Hist√≥rico</div>
        </div>
        
        <div id="view-apontamento" class="tab-body">
          <form id="form-apontamento">
            <input type="hidden" id="apt-maquina">
            <div class="form-grid">
              <div class="form-group"><label>Data</label><input type="date" id="apt-data"></div>
              <div class="form-group">
                <label>Turno</label>
                <select id="apt-turno">
                  <option>Turno 1</option><option>Turno 2</option><option>Turno 3</option>
                </select>
              </div>
            </div>
            <div class="form-group"><label>Motivo da Parada</label><select id="apt-motivo"><option value="">Carregando...</option></select></div>
            <div class="form-group"><label>Servi√ßos Realizados</label><select id="apt-servico"><option value="">Carregando...</option></select></div>
            <div class="form-grid">
               <div class="form-group"><label>Pe√ßas Trocadas</label><input type="text" id="apt-pecas" placeholder="..."></div>
               <div class="form-group"><label>Custo Pe√ßas (R$)</label><input type="text" id="apt-custo" placeholder="0,00"></div>
            </div>
            <div class="form-group"><label>Observa√ß√£o</label><textarea id="apt-obs" rows="2"></textarea></div>
            <button type="button" class="save" onclick="salvarForm()">SALVAR DADOS</button>
          </form>
        </div>

        <div id="view-historico" class="tab-body hidden">
          <div class="hist-controls">
            <div class="form-group" style="margin-bottom:0">
              <label>Data In√≠cio:</label>
              <input type="date" id="hist-ini" style="width:auto; padding:6px;">
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>Data Fim:</label>
              <input type="date" id="hist-fim" style="width:auto; padding:6px;">
            </div>
            <button class="btn-buscar" onclick="buscarHistorico()">üîé Buscar</button>
            <button class="btn-tudo" onclick="buscarHistorico(true)">Ver Tudo</button>
            <button class="btn-print" onclick="imprimirRelatorio()">üñ®Ô∏è Imprimir</button>
          </div>
          <div id="hist-tabela">Selecione um per√≠odo.</div>
        </div>
      </div>
    </div>

    <script>
      let MaquinasData = {};
      let HistoricoAtual = []; // Guarda dados para impress√£o
      
      window.onload = function() {
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('apt-data').value = hoje;
        document.getElementById('hist-ini').value = hoje;
        document.getElementById('hist-fim').value = hoje;
        google.script.run.withSuccessHandler(preencherSelects).buscarListasDropdown();
      };

      function tentarLogin() {
        const u = document.getElementById('login-user').value;
        const p = document.getElementById('login-pass').value;
        const msg = document.getElementById('login-msg');
        msg.innerText = "Verificando...";
        google.script.run.withSuccessHandler(res => {
          if(res.sucesso) {
            document.getElementById('user-display').innerText = res.usuario;
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            iniciarMonitoramento();
          } else {
            msg.innerText = res.erro;
          }
        }).verificarLogin(u, p);
      }

      function iniciarMonitoramento() {
        atualizarTempoReal();
        setInterval(atualizarTempoReal, 5000); 
        setInterval(() => { /* Timer visual opcional */ }, 1000);
      }

      function atualizarTempoReal() {
        google.script.run.withSuccessHandler(renderizarCards).buscarDadosTempoReal();
      }

      function renderizarCards(dados) {
        MaquinasData = dados;
        const container = document.getElementById('maquinas-grid');
        container.innerHTML = "";
        
        const grupos = {};
        Object.keys(dados).forEach(nome => {
           const info = dados[nome];
           const fam = info.familia || "OUTROS";
           if(!grupos[fam]) grupos[fam] = [];
           grupos[fam].push({nome, ...info});
        });

        const familiasOrdenadas = Object.keys(grupos).sort();
        if(familiasOrdenadas.length === 0) container.innerHTML = "<p style='text-align:center'>Sem dados.</p>";

        familiasOrdenadas.forEach(fam => {
           const section = document.createElement('div');
           section.className = "family-section";
           section.innerHTML = `<div class="family-title">${fam}</div>`;
           const grid = document.createElement('div');
           grid.className = "grid";
           
           grupos[fam].sort((a,b) => a.nome.localeCompare(b.nome));

           grupos[fam].forEach(maq => {
              const agora = new Date().getTime();
              const diff = Math.floor((agora - maq.timestamp)/1000);
              
              let estadoTxt = "DESCONHECIDO";
              let classe = "parada"; 
              let cor = "#777";

              if (maq.ultimoEvento === "TEMPO PRODUZINDO") {
                 estadoTxt = "RODANDO";
                 classe = "rodando";
                 cor = "#28a745";
              } else if (maq.ultimoEvento === "TEMPO PARADA") {
                 estadoTxt = "PARADA";
                 classe = "parada";
                 cor = "#dc3545";
              }
              
              const tempoFmt = formatarSegundos(diff);
              const prodDia = formatarSegundos(maq.totalProduzindo);
              const stopDia = formatarSegundos(maq.totalParada);
              const safeName = maq.nome.replace(/\s+/g, '_');

              const card = document.createElement('div');
              card.className = `card ${classe}`;
              
              card.innerHTML = `
                <div class="card-title" onclick="abrirModal('${maq.nome}', '${maq.turnoAtual}')">${maq.nome}</div>
                <div class="card-status" style="background:${cor}">${estadoTxt}</div>
                <div class="card-timer">${tempoFmt}</div>
                <div class="card-daily-totals">
                  <div class="daily-row"><span class="daily-val-prod">Produzindo: ${prodDia}</span></div>
                  <div class="daily-row"><span class="daily-val-stop">Parado: ${stopDia}</span></div>
                </div>
                <button class="btn-stops" onclick="toggleStops('${safeName}')">‚è±Ô∏è Ver Paradas</button>
                <div id="stops-${safeName}" class="stops-list">
                   <div class="stops-row"><span class="stops-label">> 3min:</span> <span>${maq.strStop3 || '-'}</span></div>
                   <div class="stops-row"><span class="stops-label">> 10min:</span> <span>${maq.strStop10 || '-'}</span></div>
                   <div class="stops-row"><span class="stops-label">> 20min:</span> <span>${maq.strStop20 || '-'}</span></div>
                   <div class="stops-row"><span class="stops-label">> 30min:</span> <span>${maq.strStop30 || '-'}</span></div>
                </div>
                <div class="card-turno">${maq.turnoAtual}</div>
                <div class="card-footer-hint" onclick="abrirModal('${maq.nome}', '${maq.turnoAtual}')">üëÜ Toque para detalhes</div>
              `;
              grid.appendChild(card);
           });
           
           section.appendChild(grid);
           container.appendChild(section);
        });
      }

      function toggleStops(id) {
         const el = document.getElementById('stops-' + id);
         if (el.style.display === 'block') el.style.display = 'none';
         else el.style.display = 'block';
      }

      function abrirModal(maquina, turnoAtual) {
        document.getElementById('modal-detalhes').style.display = 'flex';
        document.getElementById('modal-titulo').innerText = maquina;
        document.getElementById('apt-maquina').value = maquina;
        const selTurno = document.getElementById('apt-turno');
        for(let i=0; i<selTurno.options.length; i++) {
           if(selTurno.options[i].text === turnoAtual) selTurno.selectedIndex = i;
        }
        buscarHistorico(); // Busca padr√£o (Hoje)
      }

      function fecharModal() { document.getElementById('modal-detalhes').style.display = 'none'; }

      function salvarForm() {
        const btn = document.querySelector('button.save');
        const txt = btn.innerText;
        btn.innerText = "Salvando...";
        btn.disabled = true;
        const dados = {
          maquina: document.getElementById('apt-maquina').value,
          data: document.getElementById('apt-data').value,
          turno: document.getElementById('apt-turno').value,
          motivo: document.getElementById('apt-motivo').value,
          servico: document.getElementById('apt-servico').value,
          pecas: document.getElementById('apt-pecas').value,
          custo: document.getElementById('apt-custo').value,
          obs: document.getElementById('apt-obs').value
        };
        google.script.run.withSuccessHandler(msg => {
           alert(msg);
           btn.innerText = txt;
           btn.disabled = false;
        }).salvarApontamento(dados);
      }

      function buscarHistorico(tudo = false) {
        const maquina = document.getElementById('apt-maquina').value;
        const div = document.getElementById('hist-tabela');
        div.innerHTML = "<i>Buscando...</i>";
        
        let ini = null, fim = null;
        if (!tudo) {
           ini = document.getElementById('hist-ini').value;
           fim = document.getElementById('hist-fim').value;
        }

        google.script.run.withSuccessHandler(lista => {
          HistoricoAtual = lista; // Guarda para impress√£o
          
          if(!lista || lista.length === 0) {
            div.innerHTML = "<p>Sem registros.</p>";
            return;
          }
          let html = `<div class="table-wrapper"><table>
            <thead><tr><th>Data</th><th>Turno</th><th>Ligada</th><th>Parada</th><th>>3min</th><th>>10min</th><th>>20min</th><th>>30min</th><th>CustoMO</th><th>Motivo</th><th>Pe√ßas</th><th>Obs</th></tr></thead><tbody>`;
          lista.forEach(r => {
            html += `<tr>
              <td>${r.data}</td>
              <td><b>${r.turno}</b></td>
              <td style="color:green">${r.ligada}</td>
              <td style="color:red">${r.desligada}</td>
              <td>${r.paradas3min}</td>
              <td>${r.paradas10min}</td>
              <td>${r.paradas20min}</td>
              <td>${r.paradas30min}</td>
              <td>${typeof r.custoMO === 'number' ? 'R$ '+r.custoMO.toFixed(2) : r.custoMO}</td>
              <td>${r.motivo}</td>
              <td>${r.pecas}</td>
              <td class="obs">${r.obs}</td>
            </tr>`; 
          });
          html += "</tbody></table></div>";
          div.innerHTML = html;
        }).buscarHistorico(maquina, ini, fim);
      }

      function imprimirRelatorio() {
        if (!HistoricoAtual || HistoricoAtual.length === 0) {
          alert("Busque os dados antes de imprimir.");
          return;
        }
        
        const maquina = document.getElementById('apt-maquina').value;
        const win = window.open('', '', 'height=600,width=800');
        
        let html = `<html><head><title>Relat√≥rio - ${maquina}</title>`;
        html += `<style>
          body { font-family: sans-serif; font-size: 12px; }
          h1 { font-size: 18px; margin-bottom: 5px; }
          table { width: 100%; border-collapse: collapse; margin-top: 15px; }
          th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
          th { background: #eee; }
        </style></head><body>`;
        
        html += `<h1>Relat√≥rio de Hist√≥rico</h1>`;
        html += `<h3>M√°quina: ${maquina}</h3>`;
        html += `<p>Gerado em: ${new Date().toLocaleString()}</p>`;
        
        html += `<table><thead><tr><th>Data</th><th>Turno</th><th>Ligada</th><th>Parada</th><th>Motivo</th><th>Pe√ßas</th><th>Custo MO</th></tr></thead><tbody>`;
        
        HistoricoAtual.forEach(r => {
           let custo = typeof r.custoMO === 'number' ? 'R$ '+r.custoMO.toFixed(2) : r.custoMO;
           html += `<tr>
             <td>${r.data}</td><td>${r.turno}</td><td>${r.ligada}</td><td>${r.desligada}</td>
             <td>${r.motivo}</td><td>${r.pecas}</td><td>${custo}</td>
           </tr>`;
        });
        
        html += `</tbody></table></body></html>`;
        
        win.document.write(html);
        win.document.close();
        win.print();
      }

      function preencherSelects(listas) {
        const selM = document.getElementById('apt-motivo');
        const selS = document.getElementById('apt-servico');
        selM.innerHTML = '<option value="">Selecione...</option>';
        listas.motivos.forEach(m => { let o = document.createElement('option'); o.text = m; selM.add(o); });
        selS.innerHTML = '<option value="">Selecione...</option>';
        listas.servicos.forEach(s => { let o = document.createElement('option'); o.text = s; selS.add(o); });
      }

      function switchTab(nome, event) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-body').forEach(b => b.classList.add('hidden'));
        event.currentTarget.classList.add('active');
        document.getElementById('view-'+nome).classList.remove('hidden');
      }

      function formatarSegundos(s) {
        if (typeof s !== 'number' || isNaN(s)) return "00:00:00";
        s = Math.round(s);
        const h = Math.floor(s/3600).toString().padStart(2,'0');
        const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
        const sec = (s%60).toString().padStart(2,'0');
        return `${h}:${m}:${sec}`;
      }
    </script>
  </body>
</html>
