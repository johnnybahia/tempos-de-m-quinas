<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento Fabril</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root { --primary: #0056b3; --success: #28a745; --danger: #dc3545; --dark: #333; --light: #f4f6f9; }
      body { font-family: 'Roboto', sans-serif; background-color: var(--light); margin: 0; padding: 0; color: #333; }
      
      #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #004a99, #002a5c); display: flex; justify-content: center; align-items: center; z-index: 2000; }
      .login-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 15px 30px rgba(0,0,0,0.3); width: 90%; max-width: 320px; text-align: center; }
      .login-logo { max-width: 180px; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto; }
      .login-card h2 { margin-top: 0; color: var(--primary); font-size: 18px; text-transform: uppercase; margin-bottom: 20px; }
      .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
      .login-card button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
      
      #app-container { display: none; padding: 10px; max-width: 1400px; margin: 0 auto; }
      header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; flex-wrap: wrap; gap: 10px; }
      h1 { margin: 0; font-size: 22px; text-transform: uppercase; color: var(--dark); }
      .user-badge { font-size: 13px; color: #555; background: #e9ecef; padding: 5px 12px; border-radius: 15px; }
      .stats-badge { font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold; margin-left: 5px; display: inline-block; }
      .stats-total { background: #e3f2fd; color: #1976d2; }
      .stats-running { background: #e8f5e9; color: #2e7d32; }
      .stats-stopped { background: #ffebee; color: #c62828; }
      
      .family-section { margin-bottom: 40px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
      .family-title { font-size: 18px; color: #fff; background: var(--primary); padding: 8px 15px; border-radius: 5px; margin: -15px -15px 15px -15px; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; }
      
      .card { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s; position: relative; overflow: hidden; display: flex; flex-direction: column; }
      .card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
      .card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: #ccc; }
      .card.rodando::before { background: var(--success); }
      .card.parada::before { background: var(--danger); }
      
      .card-title { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 10px; min-height: 35px; display: flex; align-items: center; line-height: 1.2; cursor: pointer; user-select: none; }
      .card-status { font-size: 12px; font-weight: bold; color: white; padding: 4px 10px; border-radius: 4px; display: inline-block; margin-bottom: 10px; text-transform: uppercase; align-self: flex-start; }
      .card-timer { font-size: 32px; font-family: 'Courier New', monospace; color: var(--dark); font-weight: 700; margin-bottom: 15px; }
      
      .card-daily-totals { background: #f8f9fa; border-radius: 5px; padding: 8px; font-size: 11px; color: #666; width: 100%; box-sizing: border-box; border: 1px solid #eee; }
      .daily-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
      .daily-val-prod { color: var(--success); font-weight: bold; }
      .daily-val-stop { color: var(--danger); font-weight: bold; }
      .card-turno { font-size: 11px; color: #999; margin-top: 8px; text-align: right; }
      
      .btn-stops { background: none; border: 1px solid #ddd; color: #666; font-size: 11px; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-top: 10px; width: 100%; text-align: center; font-weight: bold; }
      .btn-stops:hover { background: #eee; }

      .btn-chart { background: none; border: 1px solid #007bff; color: #007bff; font-size: 11px; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-top: 5px; width: 100%; text-align: center; font-weight: bold; }
      .btn-chart:hover { background: #e3f2fd; }

      .card-footer-hint { margin-top: 5px; padding-top: 8px; font-size: 10px; color: #999; text-align: center; text-transform: uppercase; font-weight: bold; border-top: 1px dashed #eee; width: 100%; cursor: pointer; }

      .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
      .modal-content { background: white; width: 95%; max-width: 900px; max-height: 95vh; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
      .modal-header { padding: 15px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: bold; }
      .close { cursor: pointer; font-size: 24px; }
      
      .tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #ddd; }
      .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #666; font-weight: bold; font-size: 14px; }
      .tab.active { background: white; color: var(--primary); border-top: 3px solid var(--primary); border-bottom: 1px solid white; }
      .tab-body { padding: 20px; overflow-y: auto; flex: 1; }
      .hidden { display: none; }
      
      .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .form-group { margin-bottom: 12px; }
      label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #555; text-transform: uppercase; }
      select, input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
      button.save { width: 100%; background: var(--success); color: white; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 14px; }
      
      .hist-controls { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 15px; padding: 15px; background: #f1f3f5; border-radius: 6px; }
      .hist-controls button { padding: 8px 15px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; height: 35px; }
      .btn-buscar { background: var(--primary); color: white; }
      .btn-tudo { background: #6c757d; color: white; }
      .btn-print { background: #17a2b8; color: white; margin-left: auto; }

      .table-wrapper { overflow-x: auto; }
      table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 5px; min-width: 800px; }
      th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; white-space: nowrap; }
      th { background: #f1f3f5; color: #444; font-weight: bold; }
      tr:hover { background: #f8f9fa; }
      td.obs { white-space: normal; min-width: 150px; }
    </style>
  </head>
  <body>

    <div id="login-overlay">
      <div class="login-card">
        <img src="https://i.ibb.co/FGGjdsM/LOGO-MARFIM.jpg" alt="Logo Marfim" class="login-logo">
        <h2>Monitoramento online de produ√ß√£o</h2>
        <input type="text" id="login-user" placeholder="Usu√°rio">
        <input type="password" id="login-pass" placeholder="Senha">
        <button onclick="tentarLogin()">ENTRAR</button>
        <div id="login-msg" style="color:red; font-size:12px; margin-top:10px;"></div>
      </div>
    </div>

    <div id="app-container">
      <header>
        <div>
          <h1>Painel de Produ√ß√£o</h1>
          <div style="margin-top:8px;">
            <span class="stats-badge stats-total" id="stats-total">0 m√°quinas</span>
            <span class="stats-badge stats-running" id="stats-running">0 rodando</span>
            <span class="stats-badge stats-stopped" id="stats-stopped">0 paradas</span>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button onclick="abrirModalRelatorioFamilia()" style="padding:8px 15px; background:#007bff; color:white; border:none; border-radius:5px; font-size:13px; cursor:pointer; font-weight:bold;">
            üìã Gerar Relat√≥rio por Fam√≠lia
          </button>
          <input type="text" id="search-machine" placeholder="üîç Buscar m√°quina..."
            style="padding:8px 12px; border:1px solid #ddd; border-radius:5px; font-size:13px; width:200px;"
            oninput="filtrarMaquinas(this.value)">
          <div class="user-badge" id="user-display">Usu√°rio</div>
        </div>
      </header>
      
      <div id="maquinas-grid" class="grid">
        <div style="text-align:center; padding:40px;">
          <div style="font-size:14px; color:#666;">‚è≥ Carregando dados das m√°quinas...</div>
        </div>
      </div>
    </div>

    <div id="modal-detalhes" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span id="modal-titulo">M√°quina</span>
          <span class="close" onclick="fecharModal()">&times;</span>
        </div>
        <div class="tabs">
          <div class="tab active" onclick="switchTab('apontamento', event)">üìù Apontamento</div>
          <div class="tab" onclick="switchTab('historico', event)">üìÖ Hist√≥rico</div>
        </div>
        <div id="view-apontamento" class="tab-body">
          <form id="form-apontamento">
            <input type="hidden" id="apt-maquina">
            <div class="form-grid">
              <div class="form-group"><label>Data</label><input type="date" id="apt-data"></div>
              <div class="form-group">
                <label>Turno</label>
                <select id="apt-turno">
                  <option>Turno 1</option><option>Turno 2</option><option>Turno 3</option>
                </select>
              </div>
            </div>
            <div class="form-group"><label>Motivo da Parada</label><select id="apt-motivo"><option value="">Carregando...</option></select></div>
            <div class="form-group"><label>Servi√ßos Realizados</label><select id="apt-servico"><option value="">Carregando...</option></select></div>
            <div class="form-grid">
               <div class="form-group"><label>Pe√ßas Trocadas</label><input type="text" id="apt-pecas" placeholder="..."></div>
               <div class="form-group"><label>Custo Pe√ßas (R$)</label><input type="text" id="apt-custo" placeholder="0,00"></div>
            </div>
            <div class="form-group"><label>Observa√ß√£o</label><textarea id="apt-obs" rows="2"></textarea></div>
            <button type="button" class="save" onclick="salvarForm()">SALVAR DADOS</button>
          </form>
        </div>
        <div id="view-historico" class="tab-body hidden">
          <div class="hist-controls">
            <div class="form-group" style="margin-bottom:0"><label>Data In√≠cio:</label><input type="date" id="hist-ini" style="width:auto; padding:6px;"></div>
            <div class="form-group" style="margin-bottom:0"><label>Data Fim:</label><input type="date" id="hist-fim" style="width:auto; padding:6px;"></div>
            <button class="btn-buscar" onclick="buscarHistorico()">üîé Buscar</button>
            <button class="btn-tudo" onclick="buscarHistorico(true)">Ver Tudo</button>
            <button class="btn-print" onclick="imprimirRelatorio()">üñ®Ô∏è Imprimir</button>
          </div>
          <div id="hist-tabela">Selecione um per√≠odo.</div>
        </div>
      </div>
    </div>

    <div id="modal-paradas-criticas" class="modal">
      <div class="modal-content" style="max-width:500px;">
        <div class="modal-header">
          <span id="modal-paradas-titulo">üî¥ Paradas Cr√≠ticas</span>
          <span class="close" onclick="fecharModalParadas()">&times;</span>
        </div>
        <div style="padding:20px;">
          <div id="paradas-criticas-info" style="margin-bottom:15px; padding:10px; background:#f8f9fa; border-radius:5px; font-size:12px;">
            <strong id="paradas-maquina-nome"></strong><br>
            <span id="paradas-turno-info" style="color:#666;"></span>
          </div>
          <div id="paradas-criticas-conteudo" style="text-align:center; padding:20px; color:#999;">Carregando...</div>
        </div>
      </div>
    </div>
    
    <div id="modal-grafico" class="modal">
      <div class="modal-content" style="max-width:900px; max-height: 95vh; overflow:hidden; display:flex; flex-direction:column;">
        <div class="modal-header">
          <span id="grafico-titulo">üìä An√°lise 30 Dias</span>
          <span class="close" onclick="fecharModalGrafico()">&times;</span>
        </div>
        <div style="padding:20px; flex:1; overflow-y:auto;">
          <div id="grafico-loading" style="text-align:center; color:#999;">Carregando dados...</div>
          <div id="charts-container" style="display:none;">
            <div style="margin-bottom:30px;">
               <h3 style="margin:0 0 10px 0; color:#333; font-size:14px; border-left:4px solid #007bff; padding-left:10px;">TURNO 1</h3>
               <div style="height:200px; position:relative;"><canvas id="chartT1"></canvas></div>
            </div>
            <div style="margin-bottom:30px;">
               <h3 style="margin:0 0 10px 0; color:#333; font-size:14px; border-left:4px solid #28a745; padding-left:10px;">TURNO 2</h3>
               <div style="height:200px; position:relative;"><canvas id="chartT2"></canvas></div>
            </div>
            <div style="margin-bottom:10px;">
               <h3 style="margin:0 0 10px 0; color:#333; font-size:14px; border-left:4px solid #ffc107; padding-left:10px;">TURNO 3</h3>
               <div style="height:200px; position:relative;"><canvas id="chartT3"></canvas></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="modal-relatorio-familia" class="modal">
       <div class="modal-content" style="max-width:95%; max-height:90vh; overflow-y:auto;">
        <div class="modal-header">
          <span id="relatorio-titulo">üìä Relat√≥rio por Fam√≠lia</span>
          <span class="close" onclick="fecharRelatorioFamilia()">&times;</span>
        </div>
        <div style="padding:20px; background:#f8f9fa; border-bottom:2px solid #ddd;">
          <div style="display:flex; gap:15px; align-items:flex-end; flex-wrap:wrap;">
            <div style="flex:1; min-width:200px;">
              <label style="display:block; font-size:12px; font-weight:bold; color:#555; margin-bottom:5px;">Fam√≠lia de M√°quinas:</label>
              <select id="filtro-familia" style="width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                <option value="">Selecione a fam√≠lia...</option>
              </select>
            </div>
            <div style="flex:1; min-width:150px;">
              <label style="display:block; font-size:12px; font-weight:bold; color:#555; margin-bottom:5px;">Data In√≠cio:</label>
              <input type="date" id="relatorio-data-inicio" style="width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
            </div>
            <div style="flex:1; min-width:150px;">
              <label style="display:block; font-size:12px; font-weight:bold; color:#555; margin-bottom:5px;">Data Fim:</label>
              <input type="date" id="relatorio-data-fim" style="width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
            </div>
            <div>
              <button onclick="gerarRelatorioFamilia()" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:5px; font-size:13px; cursor:pointer; font-weight:bold;">
                üìã Gerar Relat√≥rio
              </button>
            </div>
          </div>
        </div>
        <div id="relatorio-conteudo" style="padding:20px; min-height:300px;">
          <div style="text-align:center; padding:60px; color:#999;">
            <div style="font-size:16px; margin-bottom:10px;">üìä</div>
            <div>Selecione a fam√≠lia e o per√≠odo acima</div>
            <div style="font-size:12px; margin-top:5px; color:#aaa;">Clique em "Gerar Relat√≥rio" para visualizar os dados</div>
          </div>
        </div>
        <div id="relatorio-acoes" style="padding:0 20px 20px; text-align:right; display:none;">
          <button onclick="imprimirRelatorioFamilia()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:5px; font-size:13px; cursor:pointer; font-weight:bold;">
            üñ®Ô∏è Imprimir Relat√≥rio
          </button>
        </div>
      </div>
    </div>

    <script>
      let MaquinasData = {};
      let HistoricoAtual = []; 
      let FamiliasDisponiveis = []; 
      let chart1 = null, chart2 = null, chart3 = null;
      
      window.onload = function() {
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('apt-data').value = hoje;
        document.getElementById('hist-ini').value = hoje;
        document.getElementById('hist-fim').value = hoje;
        document.getElementById('relatorio-data-inicio').value = hoje;
        document.getElementById('relatorio-data-fim').value = hoje;
        google.script.run.withSuccessHandler(preencherSelects).buscarListasDropdown();
      };

      function tentarLogin() {
        const u = document.getElementById('login-user').value;
        const p = document.getElementById('login-pass').value;
        const msg = document.getElementById('login-msg');
        msg.innerText = "Verificando...";
        google.script.run.withSuccessHandler(res => {
          if(res.sucesso) {
            document.getElementById('user-display').innerText = res.usuario;
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            iniciarMonitoramento();
          } else {
            msg.innerText = res.erro;
          }
        }).verificarLogin(u, p);
      }

      function iniciarMonitoramento() {
        atualizarTempoReal();
        setInterval(atualizarTempoReal, 5000); 
      }

      function atualizarTempoReal() {
        google.script.run
          .withSuccessHandler(renderizarCards)
          .withFailureHandler(console.error)
          .buscarDadosTempoReal();
      }

      function renderizarCards(dadosRecebidos) {
        let dados = dadosRecebidos;
        if (typeof dadosRecebidos === 'string') {
          try { dados = JSON.parse(dadosRecebidos); } catch (e) { return; }
        }
        if (!dados || typeof dados !== 'object') return;

        MaquinasData = dados;
        const container = document.getElementById('maquinas-grid');
        const fragment = document.createDocumentFragment();
        
        let totalMaquinas = 0, totalRodando = 0, totalParadas = 0;
        const grupos = {};

        Object.keys(dados).forEach(nome => {
           const info = dados[nome];
           const fam = info.familia || "OUTROS";
           if(!grupos[fam]) grupos[fam] = [];
           grupos[fam].push({nome, ...info});

           totalMaquinas++;
           if (info.ultimoEvento === "TEMPO PARADA") totalRodando++;
           else if (info.ultimoEvento === "TEMPO PRODUZINDO") totalParadas++;
        });

        document.getElementById('stats-total').textContent = `${totalMaquinas} m√°quinas`;
        document.getElementById('stats-running').textContent = `${totalRodando} rodando`;
        document.getElementById('stats-stopped').textContent = `${totalParadas} parada`;

        const familias = Object.keys(grupos).sort();
        if(familias.length === 0) {
          container.innerHTML = "<p style='text-align:center'>Sem dados.</p>";
          return;
        }

        const agora = new Date().getTime();

        familias.forEach(fam => {
           const section = document.createElement('div');
           section.className = "family-section";
           section.innerHTML = `<div class="family-title">${fam}</div>`;
           const grid = document.createElement('div');
           grid.className = "grid";

           grupos[fam].sort((a,b) => a.nome.localeCompare(b.nome));

           grupos[fam].forEach(maq => {
              const diff = Math.floor((agora - maq.timestamp)/1000);
              let estadoTxt = "DESCONHECIDO", classe = "parada", cor = "#777";

              if (maq.ultimoEvento === "TEMPO PARADA") {
                 estadoTxt = "RODANDO"; classe = "rodando"; cor = "#28a745";
              } else if (maq.ultimoEvento === "TEMPO PRODUZINDO") {
                 estadoTxt = "PARADA"; classe = "parada"; cor = "#dc3545";
              }

              const tempoFmt = formatarSegundos(diff);
              const prodDia = formatarSegundos(maq.totalProduzindo);
              const stopDia = formatarSegundos(maq.totalParada);

              const card = document.createElement('div');
              card.className = `card ${classe}`;
              
              // Exibir hor√°rio de in√≠cio se dispon√≠vel
              let horarioInicioHTML = '';
              if (maq.horarioInicio && maq.horarioInicio !== "") {
                horarioInicioHTML = `<div style="font-size:10px; color:#666; text-align:center; margin-bottom:5px;">
                  üïê In√≠cio turno: ${maq.horarioInicio}
                </div>`;
              }
              
              const ultimoEvento = new Date(maq.timestamp);
              const debugInfo = `√öltimo: ${ultimoEvento.toLocaleTimeString('pt-BR')} - ${maq.ultimoEvento}`;

              card.innerHTML = `
                <div class="card-title">${maq.nome}</div>
                <div class="card-status" style="background:${cor}">${estadoTxt}</div>
                <div class="card-timer">${tempoFmt}</div>
                <div style="font-size:9px; color:#999; text-align:center; margin-bottom:8px;" title="${debugInfo}">
                  Desde: ${ultimoEvento.toLocaleTimeString('pt-BR')}
                </div>
                ${horarioInicioHTML}
                <div class="card-daily-totals">
                  <div class="daily-row"><span class="daily-val-prod">Produzindo: ${prodDia}</span></div>
                  <div class="daily-row"><span class="daily-val-stop">Parado: ${stopDia}</span></div>
                </div>
                <button class="btn-stops" onclick="abrirModalParadas('${maq.nome}', '${maq.turnoAtual}')">üî¥ Verificar Paradas Cr√≠ticas</button>
                <button class="btn-chart" onclick="abrirGrafico('${maq.nome}')">üìä An√°lise 30 Dias</button>
                <div class="card-turno">${maq.turnoAtual}</div>
                <div class="card-footer-hint" onclick="abrirModal('${maq.nome}', '${maq.turnoAtual}')">üëÜ Toque para detalhes</div>
              `;
              grid.appendChild(card);
           });
           section.appendChild(grid);
           fragment.appendChild(section);
        });
        container.innerHTML = "";
        container.appendChild(fragment);
      }

      function formatarSegundos(s) {
        if (typeof s !== 'number' || isNaN(s)) return "00:00:00";
        s = Math.round(s);
        let h = Math.floor(s/3600).toString().padStart(2,'0');
        let m = Math.floor((s%3600)/60).toString().padStart(2,'0');
        let sec = (s%60).toString().padStart(2,'0');
        return `${h}:${m}:${sec}`;
      }
      function abrirModal(nome, turno) {
         document.getElementById('modal-detalhes').style.display = 'flex';
         document.getElementById('modal-titulo').innerText = nome;
         document.getElementById('apt-maquina').value = nome;
         
         const selTurno = document.getElementById('apt-turno');
         for(let i=0; i<selTurno.options.length; i++) {
            if(selTurno.options[i].text === turno) selTurno.selectedIndex = i;
         }
         
         buscarHistorico();
      }
      function fecharModal() { document.getElementById('modal-detalhes').style.display = 'none'; }
      function abrirModalParadas(nome, turno) {
         document.getElementById('modal-paradas-criticas').style.display = 'flex';
         document.getElementById('paradas-criticas-conteudo').innerHTML = "Carregando...";
         document.getElementById('paradas-maquina-nome').innerText = nome;
         document.getElementById('paradas-turno-info').innerText = turno;
         
         google.script.run.withSuccessHandler(paradas => {
            if(!paradas || paradas.length === 0) document.getElementById('paradas-criticas-conteudo').innerHTML = "Sem paradas cr√≠ticas.";
            else {
               let html = '<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(80px, 1fr)); gap:10px;">';
               paradas.forEach(p => {
                 let cor = '#ffa500'; // default amarelo
                 let dur = p.duracao;
                 if(dur > 1800) cor = '#dc3545';
                 else if(dur > 1200) cor = '#ff6b00';
                 else if(dur > 600) cor = '#ff8c00';
                 
                 html += `<div style="background:white; border:2px solid ${cor}; border-radius:8px; padding:12px 8px; text-align:center;">
                   <div style="color:${cor}; font-weight:bold; font-size:12px;">${p.duracaoFmt}</div>
                 </div>`;
               });
               html += '</div>';
               document.getElementById('paradas-criticas-conteudo').innerHTML = html;
            }
         }).buscarParadasTurnoAtual(nome, turno, new Date().getTime());
      }
      function fecharModalParadas() { document.getElementById('modal-paradas-criticas').style.display = 'none'; }
      
      function abrirGrafico(maquina) {
        document.getElementById('modal-grafico').style.display = 'flex';
        document.getElementById('grafico-titulo').innerText = "üìä " + maquina;
        document.getElementById('grafico-loading').style.display = 'block';
        document.getElementById('charts-container').style.display = 'none';
        
        google.script.run.withSuccessHandler(renderizarGrafico).buscarDadosGrafico(maquina);
      }
      
      function fecharModalGrafico() {
        document.getElementById('modal-grafico').style.display = 'none';
        if(chart1) { chart1.destroy(); chart1 = null; }
        if(chart2) { chart2.destroy(); chart2 = null; }
        if(chart3) { chart3.destroy(); chart3 = null; }
      }
      
      function renderizarGrafico(dados) {
        document.getElementById('grafico-loading').style.display = 'none';
        document.getElementById('charts-container').style.display = 'block';
        
        // Meta de 4:40 = 4 + 40/60 = 4.67 horas
        const metaData = dados.labels.map(() => 4.67);

        function criarChart(idCanvas, labels, dataValues, cor) {
           const ctx = document.getElementById(idCanvas).getContext('2d');
           return new Chart(ctx, {
               data: {
                   labels: labels,
                   datasets: [
                       {
                           type: 'bar',
                           label: 'Horas Rodando',
                           data: dataValues,
                           backgroundColor: cor,
                           borderColor: cor,
                           borderWidth: 1,
                           order: 2
                       },
                       {
                           type: 'line',
                           label: 'Meta (04:40)',
                           data: metaData,
                           borderColor: '#FF0000', 
                           borderWidth: 2,
                           borderDash: [5, 5], 
                           pointRadius: 0,
                           tension: 0,
                           order: 1
                       }
                   ]
               },
               options: {
                   responsive: true,
                   maintainAspectRatio: false,
                   scales: {
                       y: { 
                           beginAtZero: true,
                           title: { display: true, text: 'Horas' },
                           suggestedMax: 6 
                       }
                   },
                   plugins: { 
                     legend: { display: true },
                     tooltip: {
                       callbacks: {
                         label: function(context) {
                           let label = context.dataset.label || '';
                           if (label) label += ': ';
                           if (context.parsed.y !== null) label += context.parsed.y.toFixed(2) + ' h';
                           return label;
                         }
                       }
                     }
                   }
               }
           });
        }

        if(chart1) chart1.destroy();
        if(chart2) chart2.destroy();
        if(chart3) chart3.destroy();

        chart1 = criarChart('chartT1', dados.labels, dados.t1, '#007bff'); 
        chart2 = criarChart('chartT2', dados.labels, dados.t2, '#28a745'); 
        chart3 = criarChart('chartT3', dados.labels, dados.t3, '#ffc107'); 
      }
      
      function preencherSelects(l) {
         const s = document.getElementById('apt-motivo');
         s.innerHTML = "";
         l.motivos.forEach(m => { let o = document.createElement('option'); o.text = m; s.add(o); });
      }
      function salvarForm() { 
         const btn = document.querySelector('button.save');
         const txt = btn.innerText;
         btn.innerText = "Salvando...";
         btn.disabled = true;
         const dados = {
          maquina: document.getElementById('apt-maquina').value,
          data: document.getElementById('apt-data').value,
          turno: document.getElementById('apt-turno').value,
          motivo: document.getElementById('apt-motivo').value,
          servico: document.getElementById('apt-servico').value,
          pecas: document.getElementById('apt-pecas').value,
          custo: document.getElementById('apt-custo').value,
          obs: document.getElementById('apt-obs').value
         };
         google.script.run.withSuccessHandler(msg => {
            alert(msg);
            btn.innerText = txt;
            btn.disabled = false;
         }).salvarApontamento(dados);
      }
      function buscarHistorico() {
         document.getElementById('hist-tabela').innerHTML = "Carregando...";
         google.script.run.withSuccessHandler(lista => {
            if(!lista || lista.length === 0) {
              document.getElementById('hist-tabela').innerHTML = "<p style='text-align:center; color:#999; padding:20px;'>Sem registros.</p>";
              return;
            }
            let html = `<div class="table-wrapper"><table><thead><tr><th>Data</th><th>Turno</th><th style="background:#e8f5e9;">Tempo Ligada</th><th style="background:#ffebee;">Tempo Parada</th><th>Custo MO</th><th>Motivo</th><th>Obs</th></tr></thead><tbody>`;
            lista.forEach(r => {
              html += `<tr><td>${r.data}</td><td>${r.turno}</td><td>${r.ligada}</td><td>${r.desligada}</td><td>${r.custoMO}</td><td>${r.motivo}</td><td>${r.obs}</td></tr>`;
            });
            html += "</tbody></table></div>";
            document.getElementById('hist-tabela').innerHTML = html;
         }).buscarHistorico(document.getElementById('apt-maquina').value, 
                            document.getElementById('hist-ini').value, 
                            document.getElementById('hist-fim').value);
      }
      function filtrarMaquinas(v) {
         v = v.toLowerCase();
         document.querySelectorAll('.card').forEach(c => {
            c.style.display = c.textContent.toLowerCase().includes(v) ? 'flex' : 'none';
         });
         // Ocultar se√ß√µes vazias
         document.querySelectorAll('.family-section').forEach(s => {
           const visible = s.querySelectorAll('.card[style="display: flex;"]').length > 0 || s.querySelectorAll('.card:not([style*="display: none"])').length > 0;
           s.style.display = visible ? 'block' : 'none';
         });
      }
      function switchTab(t, e) {
         document.querySelectorAll('.tab-body').forEach(b => b.classList.add('hidden'));
         document.getElementById('view-'+t).classList.remove('hidden');
         document.querySelectorAll('.tab').forEach(tb => tb.classList.remove('active'));
         e.currentTarget.classList.add('active');
      }
      function abrirModalRelatorioFamilia() { document.getElementById('modal-relatorio-familia').style.display = 'flex'; preencherSelectsRelatorio(); }
      function fecharRelatorioFamilia() { document.getElementById('modal-relatorio-familia').style.display = 'none'; }
      function preencherSelectsRelatorio() {
          const selectFamilia = document.getElementById('filtro-familia');
          selectFamilia.innerHTML = '<option value="">Selecione...</option>';
          FamiliasDisponiveis.forEach(fam => {
             const option = document.createElement('option'); option.value = fam; option.textContent = fam;
             selectFamilia.appendChild(option);
          });
      }
      function gerarRelatorioFamilia() { /* ... Mantido ... */ }
      function imprimirRelatorioFamilia() { /* ... Mantido ... */ }
    </script>
  </body>
</html>
