<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento Fabril</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
      :root { --primary: #0056b3; --success: #28a745; --danger: #dc3545; --dark: #333; --light: #f4f6f9; }
      body { font-family: 'Roboto', sans-serif; background-color: var(--light); margin: 0; padding: 0; color: #333; }
      
      #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #004a99, #002a5c); display: flex; justify-content: center; align-items: center; z-index: 2000; }
      .login-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 15px 30px rgba(0,0,0,0.3); width: 90%; max-width: 320px; text-align: center; }
      .login-logo { max-width: 180px; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto; }
      .login-card h2 { margin-top: 0; color: var(--primary); font-size: 18px; text-transform: uppercase; margin-bottom: 20px; }
      .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
      .login-card button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
      
      #app-container { display: none; padding: 10px; max-width: 1400px; margin: 0 auto; }
      header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; flex-wrap: wrap; gap: 10px; }
      h1 { margin: 0; font-size: 22px; text-transform: uppercase; color: var(--dark); }
      .user-badge { font-size: 13px; color: #555; background: #e9ecef; padding: 5px 12px; border-radius: 15px; }
      .stats-badge { font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold; margin-left: 5px; display: inline-block; }
      .stats-total { background: #e3f2fd; color: #1976d2; }
      .stats-running { background: #e8f5e9; color: #2e7d32; }
      .stats-stopped { background: #ffebee; color: #c62828; }
      
      .family-section { margin-bottom: 40px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
      .family-title { 
        font-size: 18px; color: #fff; background: var(--primary); 
        padding: 8px 15px; border-radius: 5px; margin: -15px -15px 15px -15px; 
        text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; }
      
      .card { 
        background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 15px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s; position: relative; overflow: hidden; display: flex; flex-direction: column;
      }
      .card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
      
      .card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: #ccc; }
      .card.rodando::before { background: var(--success); }
      .card.parada::before { background: var(--danger); }
      
      .card-title { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 10px; min-height: 35px; display: flex; align-items: center; line-height: 1.2; cursor: pointer; user-select: none; }
      .card-status { font-size: 12px; font-weight: bold; color: white; padding: 4px 10px; border-radius: 4px; display: inline-block; margin-bottom: 10px; text-transform: uppercase; align-self: flex-start; }
      .card-timer { font-size: 32px; font-family: 'Courier New', monospace; color: var(--dark); font-weight: 700; margin-bottom: 15px; }
      
      .card-daily-totals { background: #f8f9fa; border-radius: 5px; padding: 8px; font-size: 11px; color: #666; width: 100%; box-sizing: border-box; border: 1px solid #eee; }
      .daily-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
      .daily-val-prod { color: var(--success); font-weight: bold; }
      .daily-val-stop { color: var(--danger); font-weight: bold; }
      .card-turno { font-size: 11px; color: #999; margin-top: 8px; text-align: right; }
      
      .btn-stops { 
        background: none; border: 1px solid #ddd; color: #666; font-size: 11px; 
        padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-top: 10px; width: 100%; text-align: center; font-weight: bold;
      }
      .btn-stops:hover { background: #eee; }
      
      .stops-list {
        display: none; margin-top: 10px; background: #fff; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 10px; color: #555; max-height: 250px; overflow-y: auto;
      }

      .card-footer-hint {
        margin-top: 5px; padding-top: 8px; font-size: 10px; color: #999; text-align: center; text-transform: uppercase; font-weight: bold; border-top: 1px dashed #eee; width: 100%; cursor: pointer;
      }

      .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
      .modal-content { background: white; width: 95%; max-width: 900px; max-height: 95vh; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
      .modal-header { padding: 15px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: bold; }
      .close { cursor: pointer; font-size: 24px; }
      .tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #ddd; }
      .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #666; font-weight: bold; font-size: 14px; }
      .tab.active { background: white; color: var(--primary); border-top: 3px solid var(--primary); border-bottom: 1px solid white; }
      .tab-body { padding: 20px; overflow-y: auto; flex: 1; }
      .hidden { display: none; }
      
      .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .form-group { margin-bottom: 12px; }
      label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #555; text-transform: uppercase; }
      select, input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
      button.save { width: 100%; background: var(--success); color: white; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 14px; }

      /* Filtro e Impress√£o */
      .hist-controls { 
        display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 15px; padding: 15px; background: #f1f3f5; border-radius: 6px; 
      }
      .hist-controls button {
        padding: 8px 15px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; height: 35px;
      }
      .btn-buscar { background: var(--primary); color: white; }
      .btn-tudo { background: #6c757d; color: white; }
      .btn-print { background: #17a2b8; color: white; margin-left: auto; }

      .table-wrapper { overflow-x: auto; }
      table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 5px; min-width: 800px; }
      th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; white-space: nowrap; }
      th { background: #f1f3f5; color: #444; font-weight: bold; }
      tr:hover { background: #f8f9fa; }
      td.obs { white-space: normal; min-width: 150px; }
    </style>
  </head>
  <body>

    <div id="login-overlay">
      <div class="login-card">
        <img src="https://i.ibb.co/FGGjdsM/LOGO-MARFIM.jpg" alt="Logo Marfim" class="login-logo">
        <h2>Monitoramento online de produ√ß√£o</h2>
        <input type="text" id="login-user" placeholder="Usu√°rio">
        <input type="password" id="login-pass" placeholder="Senha">
        <button onclick="tentarLogin()">ENTRAR</button>
        <div id="login-msg" style="color:red; font-size:12px; margin-top:10px;"></div>
      </div>
    </div>

    <div id="app-container">
      <header>
        <div>
          <h1>Painel de Produ√ß√£o</h1>
          <div style="margin-top:8px;">
            <span class="stats-badge stats-total" id="stats-total">0 m√°quinas</span>
            <span class="stats-badge stats-running" id="stats-running">0 rodando</span>
            <span class="stats-badge stats-stopped" id="stats-stopped">0 paradas</span>
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button onclick="abrirModalRelatorioFamilia()" style="padding:8px 15px; background:#007bff; color:white; border:none; border-radius:5px; font-size:13px; cursor:pointer; font-weight:bold;">
            üìã Gerar Relat√≥rio por Fam√≠lia
          </button>
          <input type="text" id="search-machine" placeholder="üîç Buscar m√°quina..."
            style="padding:8px 12px; border:1px solid #ddd; border-radius:5px; font-size:13px; width:200px;"
            oninput="filtrarMaquinas(this.value)">
          <div class="user-badge" id="user-display">Usu√°rio</div>
        </div>
      </header>
      
      <div id="maquinas-grid" class="grid">
        <div style="text-align:center; padding:40px;">
          <div style="font-size:14px; color:#666;">‚è≥ Carregando dados das m√°quinas...</div>
        </div>
      </div>
    </div>

    <div id="modal-detalhes" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span id="modal-titulo">M√°quina</span>
          <span class="close" onclick="fecharModal()">&times;</span>
        </div>
        <div class="tabs">
          <div class="tab active" onclick="switchTab('apontamento', event)">üìù Apontamento</div>
          <div class="tab" onclick="switchTab('historico', event)">üìÖ Hist√≥rico</div>
        </div>
        
        <div id="view-apontamento" class="tab-body">
          <form id="form-apontamento">
            <input type="hidden" id="apt-maquina">
            <div class="form-grid">
              <div class="form-group"><label>Data</label><input type="date" id="apt-data"></div>
              <div class="form-group">
                <label>Turno</label>
                <select id="apt-turno">
                  <option>Turno 1</option><option>Turno 2</option><option>Turno 3</option>
                </select>
              </div>
            </div>
            <div class="form-group"><label>Motivo da Parada</label><select id="apt-motivo"><option value="">Carregando...</option></select></div>
            <div class="form-group"><label>Servi√ßos Realizados</label><select id="apt-servico"><option value="">Carregando...</option></select></div>
            <div class="form-grid">
               <div class="form-group"><label>Pe√ßas Trocadas</label><input type="text" id="apt-pecas" placeholder="..."></div>
               <div class="form-group"><label>Custo Pe√ßas (R$)</label><input type="text" id="apt-custo" placeholder="0,00"></div>
            </div>
            <div class="form-group"><label>Observa√ß√£o</label><textarea id="apt-obs" rows="2"></textarea></div>
            <button type="button" class="save" onclick="salvarForm()">SALVAR DADOS</button>
          </form>
        </div>

        <div id="view-historico" class="tab-body hidden">
          <div class="hist-controls">
            <div class="form-group" style="margin-bottom:0">
              <label>Data In√≠cio:</label>
              <input type="date" id="hist-ini" style="width:auto; padding:6px;">
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>Data Fim:</label>
              <input type="date" id="hist-fim" style="width:auto; padding:6px;">
            </div>
            <button class="btn-buscar" onclick="buscarHistorico()">üîé Buscar</button>
            <button class="btn-tudo" onclick="buscarHistorico(true)">Ver Tudo</button>
            <button class="btn-print" onclick="imprimirRelatorio()">üñ®Ô∏è Imprimir</button>
          </div>
          <div id="hist-tabela">Selecione um per√≠odo.</div>
        </div>
      </div>
    </div>

    <!-- Modal Paradas Cr√≠ticas -->
    <div id="modal-paradas-criticas" class="modal">
      <div class="modal-content" style="max-width:500px;">
        <div class="modal-header">
          <span id="modal-paradas-titulo">üî¥ Paradas Cr√≠ticas</span>
          <span class="close" onclick="fecharModalParadas()">&times;</span>
        </div>
        <div style="padding:20px;">
          <div id="paradas-criticas-info" style="margin-bottom:15px; padding:10px; background:#f8f9fa; border-radius:5px; font-size:12px;">
            <strong id="paradas-maquina-nome"></strong><br>
            <span id="paradas-turno-info" style="color:#666;"></span>
          </div>
          <div id="paradas-criticas-conteudo" style="text-align:center; padding:20px; color:#999;">
            Carregando...
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Relat√≥rio por Fam√≠lia -->
    <div id="modal-relatorio-familia" class="modal">
      <div class="modal-content" style="max-width:95%; max-height:90vh; overflow-y:auto;">
        <div class="modal-header">
          <span id="relatorio-titulo">üìä Relat√≥rio por Fam√≠lia</span>
          <span class="close" onclick="fecharRelatorioFamilia()">&times;</span>
        </div>

        <!-- Filtros do Relat√≥rio -->
        <div style="padding:20px; background:#f8f9fa; border-bottom:2px solid #ddd;">
          <div style="display:flex; gap:15px; align-items:flex-end; flex-wrap:wrap;">
            <div style="flex:1; min-width:200px;">
              <label style="display:block; font-size:12px; font-weight:bold; color:#555; margin-bottom:5px;">Fam√≠lia de M√°quinas:</label>
              <select id="filtro-familia" style="width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
                <option value="">Selecione a fam√≠lia...</option>
              </select>
            </div>
            <div style="flex:1; min-width:150px;">
              <label style="display:block; font-size:12px; font-weight:bold; color:#555; margin-bottom:5px;">Data In√≠cio:</label>
              <input type="date" id="relatorio-data-inicio" style="width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
            </div>
            <div style="flex:1; min-width:150px;">
              <label style="display:block; font-size:12px; font-weight:bold; color:#555; margin-bottom:5px;">Data Fim:</label>
              <input type="date" id="relatorio-data-fim" style="width:100%; padding:8px 12px; border:1px solid #ddd; border-radius:5px; font-size:13px;">
            </div>
            <div>
              <button onclick="gerarRelatorioFamilia()" style="padding:10px 20px; background:#007bff; color:white; border:none; border-radius:5px; font-size:13px; cursor:pointer; font-weight:bold;">
                üìã Gerar Relat√≥rio
              </button>
            </div>
          </div>
        </div>

        <!-- Conte√∫do do Relat√≥rio -->
        <div id="relatorio-conteudo" style="padding:20px; min-height:300px;">
          <div style="text-align:center; padding:60px; color:#999;">
            <div style="font-size:16px; margin-bottom:10px;">üìä</div>
            <div>Selecione a fam√≠lia e o per√≠odo acima</div>
            <div style="font-size:12px; margin-top:5px; color:#aaa;">Clique em "Gerar Relat√≥rio" para visualizar os dados</div>
          </div>
        </div>

        <!-- Bot√£o Imprimir -->
        <div id="relatorio-acoes" style="padding:0 20px 20px; text-align:right; display:none;">
          <button onclick="imprimirRelatorioFamilia()" style="padding:10px 20px; background:#28a745; color:white; border:none; border-radius:5px; font-size:13px; cursor:pointer; font-weight:bold;">
            üñ®Ô∏è Imprimir Relat√≥rio
          </button>
        </div>
      </div>
    </div>

    <script>
      let MaquinasData = {};
      let HistoricoAtual = []; // Guarda dados para impress√£o
      let FamiliasDisponiveis = []; // Lista de fam√≠lias dispon√≠veis
      
      window.onload = function() {
        const hoje = new Date().toISOString().split('T')[0];
        console.log("Data de hoje (frontend):", hoje);
        document.getElementById('apt-data').value = hoje;
        document.getElementById('hist-ini').value = hoje;
        document.getElementById('hist-fim').value = hoje;
        console.log("Campos de data inicializados:", {
          aptData: document.getElementById('apt-data').value,
          histIni: document.getElementById('hist-ini').value,
          histFim: document.getElementById('hist-fim').value
        });
        google.script.run.withSuccessHandler(preencherSelects).buscarListasDropdown();
      };

      function tentarLogin() {
        const u = document.getElementById('login-user').value;
        const p = document.getElementById('login-pass').value;
        const msg = document.getElementById('login-msg');
        msg.innerText = "Verificando...";
        google.script.run.withSuccessHandler(res => {
          if(res.sucesso) {
            document.getElementById('user-display').innerText = res.usuario;
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            iniciarMonitoramento();
          } else {
            msg.innerText = res.erro;
          }
        }).verificarLogin(u, p);
      }

      function iniciarMonitoramento() {
        atualizarTempoReal();
        setInterval(atualizarTempoReal, 5000); 
        setInterval(() => { /* Timer visual opcional */ }, 1000);
      }

      function atualizarTempoReal() {
        google.script.run.withSuccessHandler(renderizarCards).buscarDadosTempoReal();
      }

      function renderizarCards(dados) {
        MaquinasData = dados;
        const container = document.getElementById('maquinas-grid');

        // Calcular estat√≠sticas
        let totalMaquinas = 0;
        let totalRodando = 0;
        let totalParadas = 0;

        const grupos = {};
        Object.keys(dados).forEach(nome => {
           const info = dados[nome];
           const fam = info.familia || "OUTROS";
           if(!grupos[fam]) grupos[fam] = [];
           grupos[fam].push({nome, ...info});

           totalMaquinas++;
           // L√ìGICA INVERTIDA: "TEMPO PARADA" = est√° rodando agora
           if (info.ultimoEvento === "TEMPO PARADA") totalRodando++;
           else if (info.ultimoEvento === "TEMPO PRODUZINDO") totalParadas++;
        });

        // Atualizar badges de estat√≠sticas
        document.getElementById('stats-total').textContent = `${totalMaquinas} m√°quina${totalMaquinas !== 1 ? 's' : ''}`;
        document.getElementById('stats-running').textContent = `${totalRodando} rodando`;
        document.getElementById('stats-stopped').textContent = `${totalParadas} parada${totalParadas !== 1 ? 's' : ''}`;

        const familiasOrdenadas = Object.keys(grupos).sort();

        // Armazenar fam√≠lias dispon√≠veis para o relat√≥rio
        FamiliasDisponiveis = familiasOrdenadas;

        if(familiasOrdenadas.length === 0) {
          container.innerHTML = "<p style='text-align:center'>Sem dados.</p>";
          return;
        }

        // Usar DocumentFragment para renderiza√ß√£o mais r√°pida
        const fragment = document.createDocumentFragment();
        const agora = new Date().getTime();

        familiasOrdenadas.forEach(fam => {
           const section = document.createElement('div');
           section.className = "family-section";
           section.innerHTML = `<div class="family-title">${fam}</div>`;
           const grid = document.createElement('div');
           grid.className = "grid";

           grupos[fam].sort((a,b) => a.nome.localeCompare(b.nome));

           grupos[fam].forEach(maq => {
              const diff = Math.floor((agora - maq.timestamp)/1000);

              let estadoTxt = "DESCONHECIDO";
              let classe = "parada";
              let cor = "#777";

              // L√ìGICA INVERTIDA: O √∫ltimo evento indica o que TERMINOU, n√£o o que est√° acontecendo
              // "TEMPO PARADA" = acabou a parada, agora est√° RODANDO
              // "TEMPO PRODUZINDO" = acabou de produzir, agora est√° PARADA
              if (maq.ultimoEvento === "TEMPO PARADA") {
                 estadoTxt = "RODANDO";
                 classe = "rodando";
                 cor = "#28a745";
              } else if (maq.ultimoEvento === "TEMPO PRODUZINDO") {
                 estadoTxt = "PARADA";
                 classe = "parada";
                 cor = "#dc3545";
              }

              const tempoFmt = formatarSegundos(diff);
              const prodDia = formatarSegundos(maq.totalProduzindo);
              const stopDia = formatarSegundos(maq.totalParada);
              const safeName = maq.nome.replace(/\s+/g, '_').replace(/[^\w-]/g, '');

              const card = document.createElement('div');
              card.className = `card ${classe}`;
              card.setAttribute('data-maquina', maq.nome);
              card.setAttribute('data-turno', maq.turnoAtual);

              const ultimoEvento = new Date(maq.timestamp);
              const debugInfo = `√öltimo: ${ultimoEvento.toLocaleTimeString('pt-BR')} - ${maq.ultimoEvento}`;

              card.innerHTML = `
                <div class="card-title">${maq.nome}</div>
                <div class="card-status" style="background:${cor}">${estadoTxt}</div>
                <div class="card-timer">${tempoFmt}</div>
                <div style="font-size:9px; color:#999; text-align:center; margin-bottom:8px;" title="${debugInfo}">
                  Desde: ${ultimoEvento.toLocaleTimeString('pt-BR')}
                </div>
                <div class="card-daily-totals">
                  <div class="daily-row"><span class="daily-val-prod">Produzindo: ${prodDia}</span></div>
                  <div class="daily-row"><span class="daily-val-stop">Parado: ${stopDia}</span></div>
                </div>
                <button class="btn-stops" onclick="abrirModalParadas('${maq.nome}', '${maq.turnoAtual}')">üî¥ Verificar Paradas Cr√≠ticas</button>
                <div class="card-turno">${maq.turnoAtual}</div>
                <div class="card-footer-hint">üëÜ Toque para detalhes</div>
              `;

              // Adicionar event listeners ap√≥s inserir HTML
              const titleEl = card.querySelector('.card-title');
              titleEl.addEventListener('click', function() {
                abrirModal(card.getAttribute('data-maquina'), card.getAttribute('data-turno'));
              });

              const footerEl = card.querySelector('.card-footer-hint');
              footerEl.addEventListener('click', function() {
                abrirModal(card.getAttribute('data-maquina'), card.getAttribute('data-turno'));
              });

              grid.appendChild(card);
           });

           section.appendChild(grid);
           fragment.appendChild(section);
        });

        // Renderizar tudo de uma vez (mais r√°pido)
        container.innerHTML = "";
        container.appendChild(fragment);
      }

      function abrirModalParadas(maquina, turno) {
         const maqData = MaquinasData[maquina];
         if (!maqData) {
           alert('Dados da m√°quina n√£o encontrados');
           return;
         }

         // Atualizar informa√ß√µes do modal
         document.getElementById('paradas-maquina-nome').textContent = maquina;
         document.getElementById('paradas-turno-info').textContent = `${turno} - ${new Date().toLocaleDateString('pt-BR')}`;
         document.getElementById('paradas-criticas-conteudo').innerHTML = '<div style="padding:20px;"><i>‚è≥ Carregando paradas cr√≠ticas...</i></div>';

         // Abrir modal
         document.getElementById('modal-paradas-criticas').style.display = 'flex';

         // Buscar paradas do turno atual
         const agora = new Date();
         let dataProducao = agora.getTime();

         google.script.run.withSuccessHandler(paradas => {
           if (!paradas || paradas.length === 0) {
             document.getElementById('paradas-criticas-conteudo').innerHTML =
               '<div style="text-align:center; padding:30px; color:#999;">‚úì Nenhuma parada cr√≠tica (>3min) registrada neste turno</div>';
             return;
           }

           let html = '<div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:10px;">';

           paradas.forEach(p => {
             let corDuracao = '#666';
             let icone = '‚ö†Ô∏è';
             if (p.duracao > 1800) {
               corDuracao = '#dc3545'; // >30min vermelho
               icone = 'üî¥';
             } else if (p.duracao > 1200) {
               corDuracao = '#ff6b00'; // >20min laranja escuro
               icone = 'üü†';
             } else if (p.duracao > 600) {
               corDuracao = '#ff8c00'; // >10min laranja
               icone = 'üü°';
             } else if (p.duracao > 180) {
               corDuracao = '#ffa500'; // >3min amarelo
               icone = '‚ö†Ô∏è';
             }

             html += `<div style="background:white; border:2px solid ${corDuracao}; border-radius:8px; padding:12px 8px; text-align:center; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
               <div style="font-size:20px; margin-bottom:4px;">${icone}</div>
               <div style="color:${corDuracao}; font-weight:bold; font-size:14px;">${p.duracaoFmt}</div>
             </div>`;
           });

           html += '</div>';
           html += `<div style="text-align:center; margin-top:20px; padding:10px; background:#fff3cd; border-radius:5px; font-size:13px;">
             <strong>Total: ${paradas.length} parada(s) cr√≠tica(s)</strong>
           </div>`;

           document.getElementById('paradas-criticas-conteudo').innerHTML = html;
         }).buscarParadasTurnoAtual(maquina, turno, dataProducao);
      }

      function fecharModalParadas() {
         document.getElementById('modal-paradas-criticas').style.display = 'none';
      }

      function abrirModalRelatorioFamilia() {
        // Abrir modal
        document.getElementById('modal-relatorio-familia').style.display = 'flex';

        // Popular dropdown de fam√≠lias
        const selectFamilia = document.getElementById('filtro-familia');
        selectFamilia.innerHTML = '<option value="">Selecione a fam√≠lia...</option>';
        FamiliasDisponiveis.forEach(fam => {
          const option = document.createElement('option');
          option.value = fam;
          option.textContent = fam;
          selectFamilia.appendChild(option);
        });

        // Resetar conte√∫do
        document.getElementById('relatorio-conteudo').innerHTML = `
          <div style="text-align:center; padding:60px; color:#999;">
            <div style="font-size:16px; margin-bottom:10px;">üìä</div>
            <div>Selecione a fam√≠lia e o per√≠odo acima</div>
            <div style="font-size:12px; margin-top:5px; color:#aaa;">Clique em "Gerar Relat√≥rio" para visualizar os dados</div>
          </div>
        `;

        // Esconder bot√£o de imprimir
        document.getElementById('relatorio-acoes').style.display = 'none';

        // Inicializar datas com hoje
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('relatorio-data-inicio').value = hoje;
        document.getElementById('relatorio-data-fim').value = hoje;
      }

      function gerarRelatorioFamilia() {
        const familia = document.getElementById('filtro-familia').value;
        const dataInicio = document.getElementById('relatorio-data-inicio').value;
        const dataFim = document.getElementById('relatorio-data-fim').value;

        if (!familia) {
          alert('Por favor, selecione uma fam√≠lia de m√°quinas');
          return;
        }
        if (!dataInicio || !dataFim) {
          alert('Por favor, selecione o per√≠odo (data in√≠cio e fim)');
          return;
        }

        // Mostrar loading
        document.getElementById('relatorio-titulo').textContent = `üìä Relat√≥rio: ${familia}`;
        document.getElementById('relatorio-conteudo').innerHTML = '<div style="text-align:center; padding:60px;"><div style="font-size:18px; color:#666;">‚è≥ Gerando relat√≥rio...</div><div style="font-size:13px; color:#999; margin-top:10px;">Processando dados da fam√≠lia ' + familia + '</div></div>';
        document.getElementById('relatorio-acoes').style.display = 'none';

        // Chamar backend
        google.script.run
          .withSuccessHandler(renderizarRelatorioFamilia)
          .withFailureHandler(erro => {
            document.getElementById('relatorio-conteudo').innerHTML = '<div style="text-align:center; padding:40px; color:#dc3545;">‚ùå Erro ao gerar relat√≥rio: ' + erro + '</div>';
            document.getElementById('relatorio-acoes').style.display = 'none';
          })
          .buscarRelatorioFamilia(familia, dataInicio, dataFim);
      }

      function renderizarRelatorioFamilia(dados) {
        if (!dados || !dados.maquinas || dados.maquinas.length === 0) {
          document.getElementById('relatorio-conteudo').innerHTML = '<div style="text-align:center; padding:40px; color:#999;">üì≠ Nenhum dado encontrado para esta fam√≠lia no per√≠odo selecionado</div>';
          document.getElementById('relatorio-acoes').style.display = 'none';
          return;
        }

        let html = '';

        // Cabe√ßalho do relat√≥rio
        html += `<div style="background:#f8f9fa; padding:20px; border-radius:8px; margin-bottom:20px;">
          <h2 style="margin:0 0 15px 0; color:#333;">FAM√çLIA: ${dados.familia}</h2>
          <div style="font-size:14px; color:#666; margin-bottom:15px;">Per√≠odo: ${dados.dataInicio} at√© ${dados.dataFim}</div>
          <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:15px;">
            <div style="background:white; padding:15px; border-radius:5px; border-left:4px solid #28a745;">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">TEMPO RODANDO TOTAL</div>
              <div style="font-size:24px; font-weight:bold; color:#28a745;">${dados.totais.rodando}</div>
            </div>
            <div style="background:white; padding:15px; border-radius:5px; border-left:4px solid #dc3545;">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">TEMPO PARADO TOTAL</div>
              <div style="font-size:24px; font-weight:bold; color:#dc3545;">${dados.totais.parado}</div>
            </div>
            <div style="background:white; padding:15px; border-radius:5px; border-left:4px solid #ff8c00;">
              <div style="font-size:12px; color:#666; margin-bottom:5px;">PARADAS CR√çTICAS TOTAL</div>
              <div style="font-size:24px; font-weight:bold; color:#ff8c00;">${dados.totais.paradasCriticas}</div>
            </div>
          </div>
        </div>`;

        // Detalhamento por m√°quina
        dados.maquinas.forEach(maq => {
          html += `<div style="margin-bottom:30px; page-break-inside:avoid;">
            <div style="background:#007bff; color:white; padding:12px 20px; border-radius:5px 5px 0 0; font-weight:bold; font-size:16px;">
              ${maq.nome}
            </div>
            <div class="table-wrapper">
              <table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead>
                  <tr style="background:#f8f9fa;">
                    <th style="padding:8px; border:1px solid #ddd; text-align:left;">Data</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:center;">Turno</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:center; background:#e8f5e9;">Tempo Ligada</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:center; background:#ffebee;">Tempo Parada</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:left; background:#fff3e0;">Paradas > 3min</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:center;">Custo MO</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:left;">Motivo</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:left;">Servi√ßo</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:left;">Pe√ßas</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:center;">Custo Pe√ßas</th>
                    <th style="padding:8px; border:1px solid #ddd; text-align:left;">Obs</th>
                  </tr>
                </thead>
                <tbody>`;

          maq.turnos.forEach(turno => {
            html += `<tr>
              <td style="padding:8px; border:1px solid #ddd; font-weight:500;">${turno.data}</td>
              <td style="padding:8px; border:1px solid #ddd; text-align:center;"><span style="background:#e3f2fd; padding:4px 8px; border-radius:3px; font-weight:bold; font-size:11px;">${turno.turno}</span></td>
              <td style="padding:8px; border:1px solid #ddd; text-align:center; color:#2e7d32; font-weight:bold; background:#f1f8f4;">${turno.ligada}</td>
              <td style="padding:8px; border:1px solid #ddd; text-align:center; color:#c62828; font-weight:bold; background:#fef5f5;">${turno.desligada}</td>
              <td style="padding:8px; border:1px solid #ddd; font-size:10px; color:#e65100; font-weight:bold; background:#fff8f0;">${turno.paradas3min}</td>
              <td style="padding:8px; border:1px solid #ddd; font-weight:bold; text-align:right;">${typeof turno.custoMO === 'number' ? 'R$ '+turno.custoMO.toFixed(2) : turno.custoMO}</td>
              <td style="padding:8px; border:1px solid #ddd; font-size:11px;">${turno.motivo}</td>
              <td style="padding:8px; border:1px solid #ddd; font-size:11px;">${turno.servico || '-'}</td>
              <td style="padding:8px; border:1px solid #ddd; font-size:11px;">${turno.pecas}</td>
              <td style="padding:8px; border:1px solid #ddd; font-weight:500; text-align:right;">${typeof turno.custoPecas === 'number' ? 'R$ '+turno.custoPecas.toFixed(2) : (turno.custoPecas || '-')}</td>
              <td style="padding:8px; border:1px solid #ddd; font-size:11px; max-width:200px; white-space:normal;">${turno.obs}</td>
            </tr>`;
          });

          html += `</tbody></table></div></div>`;
        });

        document.getElementById('relatorio-conteudo').innerHTML = html;

        // Mostrar bot√£o de imprimir
        document.getElementById('relatorio-acoes').style.display = 'block';
      }

      function fecharRelatorioFamilia() {
        document.getElementById('modal-relatorio-familia').style.display = 'none';
      }

      function imprimirRelatorioFamilia() {
        const conteudo = document.getElementById('relatorio-conteudo').innerHTML;
        const familia = document.getElementById('filtro-familia').value;

        const janela = window.open('', '_blank');
        janela.document.write(`
          <html>
            <head>
              <title>Relat√≥rio - ${familia}</title>
              <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                th, td { padding: 8px; border: 1px solid #ddd; }
                th { background: #f8f9fa; font-weight: bold; }
                @media print {
                  .no-print { display: none; }
                  body { padding: 0; }
                }
              </style>
            </head>
            <body>
              ${conteudo}
              <script>
                window.onload = function() { window.print(); }
              <\/script>
            </body>
          </html>
        `);
        janela.document.close();
      }

      function abrirModal(maquina, turnoAtual) {
        document.getElementById('modal-detalhes').style.display = 'flex';
        document.getElementById('modal-titulo').innerText = maquina;
        document.getElementById('apt-maquina').value = maquina;
        const selTurno = document.getElementById('apt-turno');
        for(let i=0; i<selTurno.options.length; i++) {
           if(selTurno.options[i].text === turnoAtual) selTurno.selectedIndex = i;
        }
        buscarHistorico(); // Busca padr√£o (Hoje)
      }

      function fecharModal() { document.getElementById('modal-detalhes').style.display = 'none'; }

      function salvarForm() {
        const btn = document.querySelector('button.save');
        const txt = btn.innerText;
        btn.innerText = "Salvando...";
        btn.disabled = true;
        const dados = {
          maquina: document.getElementById('apt-maquina').value,
          data: document.getElementById('apt-data').value,
          turno: document.getElementById('apt-turno').value,
          motivo: document.getElementById('apt-motivo').value,
          servico: document.getElementById('apt-servico').value,
          pecas: document.getElementById('apt-pecas').value,
          custo: document.getElementById('apt-custo').value,
          obs: document.getElementById('apt-obs').value
        };
        google.script.run.withSuccessHandler(msg => {
           alert(msg);
           btn.innerText = txt;
           btn.disabled = false;
        }).salvarApontamento(dados);
      }

      function buscarHistorico(tudo = false) {
        const maquina = document.getElementById('apt-maquina').value;
        const div = document.getElementById('hist-tabela');
        div.innerHTML = "<i>Buscando...</i>";

        let ini = null, fim = null;
        if (!tudo) {
           ini = document.getElementById('hist-ini').value;
           fim = document.getElementById('hist-fim').value;
        }

        console.log("=== buscarHistorico FRONTEND ===");
        console.log("M√°quina:", maquina);
        console.log("Per√≠odo:", ini, "at√©", fim);
        console.log("Tudo:", tudo);

        google.script.run
          .withSuccessHandler(lista => {
            console.log("Sucesso! Recebido:", lista ? lista.length : 0, "registros");
            if (lista && lista.length > 0) {
              console.log("Primeiro registro:", lista[0]);
            }

            HistoricoAtual = lista; // Guarda para impress√£o

            if(!lista || lista.length === 0) {
              div.innerHTML = "<p style='text-align:center; color:#999; padding:20px;'>Sem registros para o per√≠odo selecionado.</p>";
              return;
            }
          let html = `<div class="table-wrapper"><table>
            <thead><tr>
              <th>Data</th>
              <th>Turno</th>
              <th style="background:#e8f5e9;">Tempo Ligada</th>
              <th style="background:#ffebee;">Tempo Parada</th>
              <th style="background:#fff3e0;">Paradas > 3min</th>
              <th>Custo MO</th>
              <th>Motivo</th>
              <th>Servi√ßo</th>
              <th>Pe√ßas</th>
              <th>Custo Pe√ßas</th>
              <th>Obs</th>
            </tr></thead><tbody>`;
          lista.forEach(r => {
            html += `<tr>
              <td style="font-weight:500;">${r.data}</td>
              <td style="text-align:center;"><span style="background:#e3f2fd; padding:4px 8px; border-radius:3px; font-weight:bold; font-size:11px;">${r.turno}</span></td>
              <td style="color:#2e7d32; font-weight:bold; background:#f1f8f4;">${r.ligada}</td>
              <td style="color:#c62828; font-weight:bold; background:#fef5f5;">${r.desligada}</td>
              <td style="font-size:10px; color:#e65100; font-weight:bold; background:#fff8f0;">${r.paradas3min}</td>
              <td style="font-weight:bold;">${typeof r.custoMO === 'number' ? 'R$ '+r.custoMO.toFixed(2) : r.custoMO}</td>
              <td style="font-size:11px;">${r.motivo}</td>
              <td style="font-size:11px;">${r.servico || '-'}</td>
              <td style="font-size:11px;">${r.pecas}</td>
              <td style="font-weight:500;">${typeof r.custoPecas === 'number' ? 'R$ '+r.custoPecas.toFixed(2) : (r.custoPecas || '-')}</td>
              <td class="obs" style="font-size:11px; max-width:200px;">${r.obs}</td>
            </tr>`;
          });
          html += "</tbody></table></div>";
          html += `<div style="margin-top:15px; padding:10px; background:#f8f9fa; border-radius:5px; text-align:center; font-size:12px; color:#666;">
            <b>${lista.length}</b> registro(s) encontrado(s)
          </div>`;
          div.innerHTML = html;
        })
        .withFailureHandler(erro => {
          console.error("ERRO ao buscar hist√≥rico:", erro);
          div.innerHTML = "<p style='text-align:center; color:#dc3545; padding:20px;'>‚ùå Erro: " + erro.message + "</p>";
        })
        .buscarHistorico(maquina, ini, fim);
      }

      function imprimirRelatorio() {
        if (!HistoricoAtual || HistoricoAtual.length === 0) {
          alert("Busque os dados antes de imprimir.");
          return;
        }
        
        const maquina = document.getElementById('apt-maquina').value;
        const win = window.open('', '', 'height=600,width=800');
        
        let html = `<html><head><title>Relat√≥rio - ${maquina}</title>`;
        html += `<style>
          body { font-family: sans-serif; font-size: 12px; }
          h1 { font-size: 18px; margin-bottom: 5px; }
          table { width: 100%; border-collapse: collapse; margin-top: 15px; }
          th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
          th { background: #eee; }
        </style></head><body>`;
        
        html += `<h1>Relat√≥rio de Hist√≥rico</h1>`;
        html += `<h3>M√°quina: ${maquina}</h3>`;
        html += `<p>Gerado em: ${new Date().toLocaleString()}</p>`;
        
        html += `<table><thead><tr><th>Data</th><th>Turno</th><th>Ligada</th><th>Parada</th><th>Motivo</th><th>Pe√ßas</th><th>Custo MO</th></tr></thead><tbody>`;
        
        HistoricoAtual.forEach(r => {
           let custo = typeof r.custoMO === 'number' ? 'R$ '+r.custoMO.toFixed(2) : r.custoMO;
           html += `<tr>
             <td>${r.data}</td><td>${r.turno}</td><td>${r.ligada}</td><td>${r.desligada}</td>
             <td>${r.motivo}</td><td>${r.pecas}</td><td>${custo}</td>
           </tr>`;
        });
        
        html += `</tbody></table></body></html>`;
        
        win.document.write(html);
        win.document.close();
        win.print();
      }

      function preencherSelects(listas) {
        const selM = document.getElementById('apt-motivo');
        const selS = document.getElementById('apt-servico');
        selM.innerHTML = '<option value="">Selecione...</option>';
        listas.motivos.forEach(m => { let o = document.createElement('option'); o.text = m; selM.add(o); });
        selS.innerHTML = '<option value="">Selecione...</option>';
        listas.servicos.forEach(s => { let o = document.createElement('option'); o.text = s; selS.add(o); });
      }

      function switchTab(nome, event) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-body').forEach(b => b.classList.add('hidden'));
        event.currentTarget.classList.add('active');
        document.getElementById('view-'+nome).classList.remove('hidden');
      }

      function formatarSegundos(s) {
        if (typeof s !== 'number' || isNaN(s)) return "00:00:00";
        s = Math.round(s);
        const h = Math.floor(s/3600).toString().padStart(2,'0');
        const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
        const sec = (s%60).toString().padStart(2,'0');
        return `${h}:${m}:${sec}`;
      }

      function filtrarMaquinas(termo) {
        termo = termo.toLowerCase().trim();
        const cards = document.querySelectorAll('.card');
        const sections = document.querySelectorAll('.family-section');

        if (!termo) {
          // Mostrar tudo
          cards.forEach(card => card.style.display = 'flex');
          sections.forEach(section => section.style.display = 'block');
          return;
        }

        // Filtrar cards
        cards.forEach(card => {
          const title = card.querySelector('.card-title');
          if (title && title.textContent.toLowerCase().includes(termo)) {
            card.style.display = 'flex';
          } else {
            card.style.display = 'none';
          }
        });

        // Esconder se√ß√µes vazias
        sections.forEach(section => {
          const visibleCards = section.querySelectorAll('.card[style*="display: flex"]');
          if (visibleCards.length === 0) {
            section.style.display = 'none';
          } else {
            section.style.display = 'block';
          }
        });
      }
    </script>
  </body>
</html>
